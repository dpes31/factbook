<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë¦¬í¬íŠ¸ ë·°ì–´ (Iframe Sandbox & Capture)</title>
    
    <!-- PPT ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <!-- Word ë³€í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- í™”ë©´ ìº¡ì²˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ (í•„ìˆ˜) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* [ê¸°ë³¸ ì„¤ì •] */
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; overflow: hidden; }
        
        /* [ì™¼ìª½] ì—ë””í„° íŒ¨ë„ */
        #editor-pane {
            width: 320px;
            min-width: 300px;
            height: 100%;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            z-index: 20;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        h2 { margin: 0 0 15px 0; font-size: 1.2rem; color: #333; }
        
        .drop-zone {
            border: 2px dashed #bbb;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #666;
            transition: 0.2s;
        }
        .drop-zone:hover { border-color: #007bff; background: #f0f7ff; color: #007bff; }

        textarea {
            flex-grow: 1;
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 10px;
            outline: none;
        }
        textarea:focus { border-color: #007bff; }

        .btn-group { display: flex; flex-direction: column; gap: 8px; }
        button {
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            font-size: 14px;
            display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        .btn-render { background: #007bff; } .btn-render:hover { background: #0056b3; }
        .btn-pdf { background: #6c757d; } .btn-pdf:hover { background: #545b62; }
        .btn-ppt { background: #28a745; } .btn-ppt:hover { background: #1e7e34; }

        .note { font-size: 0.8em; color: #666; margin-top: 15px; background: #eee; padding: 10px; border-radius: 4px; line-height: 1.4; }

        /* [ì˜¤ë¥¸ìª½] ë·°ì–´ íŒ¨ë„ */
        #viewer-pane {
            flex-grow: 1;
            height: 100%;
            background: #525659; /* PDF ë·°ì–´ ê°™ì€ ì–´ë‘ìš´ ë°°ê²½ */
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* [í•µì‹¬] Iframe ìƒŒë“œë°•ìŠ¤ */
        /* ì™¸ë¶€ ì‚¬ì´íŠ¸(ytool)ì™€ ë™ì¼í•œ ê²©ë¦¬ í™˜ê²½ ì œê³µ */
        #sandbox-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            display: block;
        }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loading-overlay {
            position: absolute; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.7);
            color: white;
            display: none;
            justify-content: center; align-items: center;
            flex-direction: column;
            z-index: 100;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- ì™¼ìª½ ì—ë””í„° -->
    <div id="editor-pane">
        <h2>ğŸ–¥ï¸ ì™„ë²½ í˜¸í™˜ ë·°ì–´</h2>
        
        <div id="drop-zone" class="drop-zone">
            íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”<br>
            (HTML, TXT, DOCX)
            <input type="file" id="file-input" accept=".html,.txt,.docx" style="display:none">
        </div>

        <textarea id="html-input" placeholder="HTML ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.&#13;&#10;&#13;&#10;[ì—…ë°ì´íŠ¸ ì™„ë£Œ]&#13;&#10;1. ì™¸ë¶€ ì‚¬ì´íŠ¸ì™€ 100% ë™ì¼í•œ ë Œë”ë§ (Iframe)&#13;&#10;2. ë””ìì¸ ê¹¨ì§ ì—†ëŠ” PPT ë³€í™˜ (ì´ë¯¸ì§€ ìº¡ì²˜)&#13;&#10;3. ì „ì²´ í˜ì´ì§€ PDF ì¸ì‡„ ì§€ì›"></textarea>
        
        <div class="btn-group">
            <button class="btn-render" onclick="renderIframe()">
                <span>ğŸ”„</span> View (ìƒˆë¡œê³ ì¹¨)
            </button>
            <button class="btn-pdf" onclick="printIframe()">
                <span>ğŸ“„</span> PDF ì €ì¥ (ì¸ì‡„)
            </button>
            <button class="btn-ppt" onclick="exportPPTAsImage()">
                <span>ğŸ“Š</span> PPT ë‹¤ìš´ë¡œë“œ (ìº¡ì²˜)
            </button>
        </div>

        <div class="note">
            <strong>âœ… í•´ê²° ì™„ë£Œ:</strong><br>
            â€¢ <strong>ì™„ë²½ ë Œë”ë§:</strong> Iframeì„ ì‚¬ìš©í•˜ì—¬ ì™¸ë¶€ íˆ´ê³¼ ë™ì¼í•˜ê²Œ ë³´ì…ë‹ˆë‹¤.<br>
            â€¢ <strong>ë””ìì¸ ìœ ì§€:</strong> í™”ë©´ì„ ê·¸ëŒ€ë¡œ ìº¡ì²˜í•˜ì—¬ PPTì— ë„£ìœ¼ë¯€ë¡œ ì˜ë¦¬ê±°ë‚˜ ê¹¨ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ë·°ì–´ -->
    <div id="viewer-pane">
        <iframe id="sandbox-frame" title="Report Viewer"></iframe>
        
        <div id="loading-overlay">
            <div class="spinner"></div>
            <div id="loading-text">ì²˜ë¦¬ ì¤‘...</div>
        </div>
    </div>

    <script>
        const frame = document.getElementById('sandbox-frame');
        const overlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        // 1. Iframe ë Œë”ë§ (Sandbox ë°©ì‹)
        function renderIframe() {
            const input = document.getElementById('html-input').value;
            if (!input.trim()) { alert("ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            // Iframe ë‚´ë¶€ì— HTML ì£¼ì…
            // ytool ë“± ì™¸ë¶€ íˆ´ê³¼ ë™ì¼í•œ í™˜ê²½ì„ ë§Œë“¤ì–´ì£¼ê¸° ìœ„í•´ ì „ì²´ ë¬¸ì„œë¥¼ ì‘ì„±
            const doc = frame.contentDocument || frame.contentWindow.document;
            
            doc.open();
            doc.write(input);
            doc.close();
            
            // ìŠ¤íƒ€ì¼ ë³´ì • (ì˜µì…˜): ì¸ì‡„ ì‹œ ì—¬ë°± ì¡°ì • ë“±ì„ ìœ„í•´ ìŠ¤íƒ€ì¼ ì£¼ì…
            const style = doc.createElement('style');
            style.textContent = `
                @media print {
                    @page { margin: 0; size: auto; }
                    body { -webkit-print-color-adjust: exact; margin: 0; padding: 0; }
                }
                /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ (ì„ íƒ) */
                ::-webkit-scrollbar { width: 10px; }
                ::-webkit-scrollbar-track { background: #f1f1f1; }
                ::-webkit-scrollbar-thumb { background: #888; border-radius: 5px; }
                ::-webkit-scrollbar-thumb:hover { background: #555; }
            `;
            doc.head.appendChild(style);
        }

        // 2. Iframe ì¸ì‡„ (PDF ì €ì¥)
        function printIframe() {
            if (!frame.contentWindow) return;
            frame.contentWindow.focus();
            frame.contentWindow.print();
        }

        // 3. PPT ë³€í™˜ (ì´ë¯¸ì§€ ìº¡ì²˜ ë°©ì‹ - ë””ìì¸ ì™„ë²½ ë³´ì¡´)
        async function exportPPTAsImage() {
            const doc = frame.contentDocument || frame.contentWindow.document;
            
            // ì‚¬ìš©ìì˜ HTML êµ¬ì¡° ë¶„ì„ (ì„¹ì…˜ ì°¾ê¸°)
            // ë³´í†µ <section> íƒœê·¸ë¥¼ ì“°ê±°ë‚˜, íŠ¹ì • í´ë˜ìŠ¤ë¡œ ìŠ¬ë¼ì´ë“œë¥¼ êµ¬ë¶„í•¨
            // ë§Œì•½ êµ¬ì¡°ê°€ ì—†ë‹¤ë©´ ì „ì²´ë¥¼ í•˜ë‚˜ë¡œ ìº¡ì²˜
            let slides = doc.querySelectorAll('section');
            if (slides.length === 0) {
                // sectionì´ ì—†ìœ¼ë©´ .slide í´ë˜ìŠ¤ë‚˜, ìµœìƒìœ„ divì˜ ìì‹ë“¤ì„ ì‹œë„
                slides = doc.querySelectorAll('.slide');
            }
            if (slides.length === 0) {
                // ê·¸ë˜ë„ ì—†ìœ¼ë©´ body ì „ì²´ë¥¼ í•˜ë‚˜ë¡œ ì·¨ê¸‰ (ë˜ëŠ” ìˆ˜ë™ ë¶„í•  ë¡œì§ í•„ìš”)
                // ì—¬ê¸°ì„œëŠ” ì‚¬ìš©ìì˜ ë¦¬í¬íŠ¸ êµ¬ì¡°(section)ê°€ ìˆë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜ ì „ì²´ë¥¼ ì°ìŒ
                if(confirm("ìŠ¬ë¼ì´ë“œ(<section> ë˜ëŠ” .slide)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì „ì²´ í™”ë©´ì„ í•˜ë‚˜ì˜ ì¥í‘œë¡œ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    slides = [doc.body];
                } else {
                    return;
                }
            }

            showLoading(true, "PPT ìƒì„± ì¤‘... (í™”ë©´ ìº¡ì²˜)");

            try {
                let pptx = new PptxGenJS();
                pptx.layout = 'LAYOUT_16x9'; 

                // ìˆœì°¨ì ìœ¼ë¡œ ìº¡ì²˜
                for (let i = 0; i < slides.length; i++) {
                    const slideElem = slides[i];
                    
                    // html2canvasë¡œ í•´ë‹¹ ìš”ì†Œ ìº¡ì²˜
                    // iframe ë‚´ë¶€ ìš”ì†Œ ìº¡ì²˜ë¥¼ ìœ„í•´ window ê°ì²´ ì „ë‹¬ í•„ìš”í•  ìˆ˜ ìˆìŒ
                    // ì—¬ê¸°ì„œëŠ” iframe ë‚´ë¶€ì—ì„œ ìº¡ì²˜í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì •í™•í•˜ë¯€ë¡œ,
                    // html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ iframe ë‚´ë¶€ì—ë„ ë¡œë“œë˜ì–´ì•¼ í•  ìˆ˜ë„ ìˆìŒ.
                    // -> ê°„ë‹¨í•œ í•´ê²°ì±…: ë©”ì¸ ìœˆë„ìš°ì˜ html2canvasë¥¼ ì‚¬ìš©í•˜ì—¬ iframe body ìº¡ì²˜ (CORS ì œí•œ ì—†ìŒ)
                    
                    // ìº¡ì²˜ ì „ ìŠ¤íƒ€ì¼ ì¡°ì • (ë°°ê²½ìƒ‰ í°ìƒ‰ ê°•ì œ ë“±)
                    const originalBg = slideElem.style.backgroundColor;
                    if (!originalBg) slideElem.style.backgroundColor = "white";

                    // html2canvas ì˜µì…˜: scaleì„ ë†’ì—¬ ê³ í™”ì§ˆ ìº¡ì²˜
                    const canvas = await html2canvas(slideElem, {
                        scale: 2, // 2ë°° í•´ìƒë„
                        useCORS: true,
                        windowWidth: slideElem.scrollWidth,
                        windowHeight: slideElem.scrollHeight
                    });
                    
                    // ë³µêµ¬
                    slideElem.style.backgroundColor = originalBg;

                    const imgData = canvas.toDataURL('image/png');

                    // PPT ìŠ¬ë¼ì´ë“œ ì¶”ê°€
                    let slide = pptx.addSlide();
                    
                    // ì´ë¯¸ì§€ë¥¼ ìŠ¬ë¼ì´ë“œì— ê½‰ ì°¨ê²Œ ë„£ê¸° (ë¹„ìœ¨ ìœ ì§€)
                    // ì´ë¯¸ì§€ ë¹„ìœ¨ ê³„ì‚°
                    const imgRatio = canvas.width / canvas.height;
                    const slideRatio = 16 / 9; // PPT ê¸°ë³¸ ë¹„ìœ¨
                    
                    let w, h, x, y;
                    
                    if (imgRatio > slideRatio) {
                        // ì´ë¯¸ì§€ê°€ ë” ë‚©ì‘í•¨ -> ê°€ë¡œë¥¼ ê½‰ ì±„ì›€
                        w = "100%";
                        h = (100 / imgRatio * slideRatio) + "%"; // ë†’ì´ ìë™ ê³„ì‚°
                        x = 0;
                        y = (100 - parseFloat(h)) / 2 + "%"; // ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬
                    } else {
                        // ì´ë¯¸ì§€ê°€ ë” ê¸¸ì­‰í•¨ -> ì„¸ë¡œë¥¼ ê½‰ ì±„ì›€
                        h = "100%";
                        w = (100 * imgRatio / slideRatio) + "%";
                        y = 0;
                        x = (100 - parseFloat(w)) / 2 + "%"; // ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬
                    }

                    slide.addImage({ data: imgData, x: x, y: y, w: w, h: h });
                }

                pptx.writeFile({ fileName: `Capture_Slides_${new Date().toISOString().slice(0,10)}.pptx` });

            } catch (err) {
                console.error(err);
                alert("PPT ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            } finally {
                showLoading(false);
            }
        }

        // ë¡œë”© UI ì œì–´
        function showLoading(show, text) {
            overlay.style.display = show ? 'flex' : 'none';
            if (text) loadingText.innerText = text;
        }

        // íŒŒì¼ ì²˜ë¦¬
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
        dropZone.ondragleave = () => dropZone.classList.remove('dragover');
        dropZone.ondrop = (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };
        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        function handleFile(file) {
            if (!file) return;
            if (file.name.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mammoth.convertToHtml({arrayBuffer: e.target.result})
                        .then(res => {
                            document.getElementById('html-input').value = res.value; // WordëŠ” section êµ¬ë¶„ì´ ì—†ìœ¼ë¯€ë¡œ ì£¼ì˜
                            renderIframe();
                        })
                        .catch(err => alert(err));
                };
                reader.readAsArrayBuffer(file);
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('html-input').value = e.target.result;
                    renderIframe();
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>
